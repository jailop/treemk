name: macOS DMG Build and Release

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to upload to (e.g., v0.2.0)'
        required: false
        default: ''
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  
jobs:
  build-macos-dmg:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Detect version
        id: version
        run: |
          # Try to get version from latest git tag
          tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$tag" ]; then
            # Remove 'v' prefix if present
            version=${tag#v}
          else
            # No tags, generate version from commit count and hash
            commitCount=$(git rev-list --count HEAD)
            commitHash=$(git rev-parse --short HEAD)
            version="0.0.${commitCount}-${commitHash}"
          fi
          
          echo "Detected version: $version"
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "version=$version" >> $GITHUB_OUTPUT
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3'
          host: 'mac'
          target: 'desktop'
          arch: 'clang_64'
          modules: 'qtwebengine qtwebchannel qtpositioning'
          cache: true
      
      - name: Detect architecture and install dependencies
        run: |
          ARCH=$(uname -m)
          echo "Building for architecture: $ARCH"
          
          if [ "$ARCH" = "arm64" ]; then
            # arm64 - use Homebrew (default location)
            brew install md4c create-dmg
          else
            # x86_64 - need to use x86_64 Homebrew or build from source
            # For now, install via conda-forge or build from source
            brew install create-dmg
            
            # Install md4c from source for x86_64
            cd /tmp
            curl -L https://github.com/mity/md4c/archive/release-0.5.2.tar.gz -o md4c.tar.gz
            tar xzf md4c.tar.gz
            cd md4c-release-0.5.2
            mkdir build && cd build
            cmake -DCMAKE_BUILD_TYPE=Release \
                  -DCMAKE_INSTALL_PREFIX=/usr/local \
                  -DCMAKE_OSX_ARCHITECTURES=x86_64 ..
            make -j$(sysctl -n hw.ncpu)
            sudo make install
            cd $GITHUB_WORKSPACE
          fi
      
      - name: Configure CMake
        run: |
          cmake -B build \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_PREFIX_PATH="${Qt6_DIR}"
      
      - name: Build
        run: cmake --build build --parallel
      
      - name: Deploy Qt dependencies
        run: |
          macdeployqt build/treemk.app -verbose=2
      
      - name: Create DMG using script
        env:
          CI: true
          VERSION: ${{ env.VERSION }}
        run: |
          chmod +x create_dmg.sh
          ./create_dmg.sh
          
          # Detect architecture and rename with suffix
          ARCH=$(uname -m)
          mv TreeMk-${{ env.VERSION }}.dmg TreeMk-${{ env.VERSION }}-macOS-${ARCH}.dmg
          ls -lh TreeMk-*.dmg
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TreeMk-macOS-DMG
          path: TreeMk-*.dmg
          retention-days: 30
      
      - name: Get release info
        id: release_info
        run: |
          # Determine release tag
          tag=""
          if [ "${{ github.event_name }}" = "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Triggered by tag push
            tag="${{ github.ref_name }}"
          elif [ -n "${{ github.event.inputs.release_tag }}" ]; then
            # Manual trigger with specified tag
            tag="${{ github.event.inputs.release_tag }}"
          else
            # Manual trigger without tag - use latest release
            tag=$(gh release list --limit 1 --json tagName -q '.[0].tagName' || echo "")
            if [ -z "$tag" ]; then
              echo "Error: No releases found. Please specify a release tag or create a release first."
              exit 1
            fi
          fi
          
          if [ -z "$tag" ]; then
            echo "Error: Could not determine release tag"
            exit 1
          fi
          
          echo "RELEASE_TAG=$tag" >> $GITHUB_ENV
          echo "Release tag: $tag"
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: TreeMk-*.dmg
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          echo "### âœ… macOS DMG Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** ${{ env.RELEASE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Created Package:**" >> $GITHUB_STEP_SUMMARY
          ls -1 TreeMk-*.dmg | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The DMG package has been uploaded to the release." >> $GITHUB_STEP_SUMMARY
