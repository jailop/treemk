name: AppImage Build and Release

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to upload to (e.g., v0.2.0)'
        required: false
        default: ''
  push:
    tags:
      - 'v[0-9]+.[0-9]+.0'

permissions:
  contents: write
  
jobs:
  build-appimage:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Detect version
        id: version
        run: |
          # Try to get version from latest git tag
          tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$tag" ]; then
            # Remove 'v' prefix if present
            version=${tag#v}
          else
            # No tags, generate version from commit count and hash
            commitCount=$(git rev-list --count HEAD)
            commitHash=$(git rev-parse --short HEAD)
            version="0.0.${commitCount}-${commitHash}"
          fi
          
          echo "Detected version: $version"
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "version=$version" >> $GITHUB_OUTPUT
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3'
          host: 'linux'
          target: 'desktop'
          arch: 'gcc_64'
          modules: 'qtwebengine qtwebchannel qtpositioning'
          cache: true
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
              cmake \
              build-essential \
              libmd4c-dev \
              libmd4c-html0-dev \
              pkg-config \
              file \
              libfuse2 \
              wget
      
      - name: Download linuxdeploy and AppImage plugin
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage
      
      - name: Configure CMake
        run: |
          cmake -B build \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_INSTALL_PREFIX=/usr \
                -DBUILD_TESTS=OFF
      
      - name: Build
        run: cmake --build build --parallel
      
      - name: Install to AppDir
        run: |
          mkdir -p AppDir
          DESTDIR=$PWD/AppDir cmake --install build
      
      - name: Copy additional files
        run: |
          # Ensure desktop file is in the right place
          mkdir -p AppDir/usr/share/applications
          cp resources/treemk.desktop AppDir/usr/share/applications/
          
          # Ensure icon is in the right place
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          cp resources/treemk.png AppDir/usr/share/icons/hicolor/256x256/apps/
          
          # Create a symlink for the icon at the AppDir root (required by AppImage)
          cp resources/treemk.png AppDir/treemk.png
      
      - name: Create AppImage
        env:
          VERSION: ${{ env.VERSION }}
        run: |
          export QMAKE=$Qt6_DIR/bin/qmake
          export LD_LIBRARY_PATH=$Qt6_DIR/lib:$LD_LIBRARY_PATH
          
          ./linuxdeploy-x86_64.AppImage \
              --appdir AppDir \
              --plugin qt \
              --output appimage \
              --desktop-file=AppDir/usr/share/applications/treemk.desktop \
              --icon-file=AppDir/usr/share/icons/hicolor/256x256/apps/treemk.png
          
          # Rename to include version
          mv TreeMk-*.AppImage TreeMk-${{ env.VERSION }}-x86_64.AppImage || \
          mv treemk-*.AppImage TreeMk-${{ env.VERSION }}-x86_64.AppImage || true
          
          # List created file
          ls -lh TreeMk-*.AppImage
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: TreeMk-AppImage
          path: TreeMk-*.AppImage
          retention-days: 30
      
      - name: Get release info
        id: release_info
        run: |
          # Determine release tag
          tag=""
          if [ "${{ github.event_name }}" = "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Triggered by tag push
            tag="${{ github.ref_name }}"
          elif [ -n "${{ github.event.inputs.release_tag }}" ]; then
            # Manual trigger with specified tag
            tag="${{ github.event.inputs.release_tag }}"
          else
            # Manual trigger without tag - use latest release
            tag=$(gh release list --limit 1 --json tagName -q '.[0].tagName' || echo "")
            if [ -z "$tag" ]; then
              echo "Error: No releases found. Please specify a release tag or create a release first."
              exit 1
            fi
          fi
          
          if [ -z "$tag" ]; then
            echo "Error: Could not determine release tag"
            exit 1
          fi
          
          echo "RELEASE_TAG=$tag" >> $GITHUB_ENV
          echo "Release tag: $tag"
        env:
          GH_TOKEN: ${{ github.token }}
      
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: TreeMk-*.AppImage
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          echo "### AppImage Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ env.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** ${{ env.RELEASE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Created Package:**" >> $GITHUB_STEP_SUMMARY
          ls -1 TreeMk-*.AppImage | sed 's/^/- /' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The AppImage has been uploaded to the release." >> $GITHUB_STEP_SUMMARY
