name: Build Windows Installer (x64)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows-x64:
    name: Build Windows Installer (x64)
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.5.0'
          modules: 'qtwebengine qtwebchannel qtpositioning'
          arch: 'win64_msvc2019_64'
      
      - name: Setup MSVC
        uses: microsoft/setup-msbuild@v2
      
      - name: Install vcpkg
        run: |
          git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
          C:\vcpkg\bootstrap-vcpkg.bat
      
      - name: Install md4c
        run: |
          C:\vcpkg\vcpkg install md4c:x64-windows
      
      - name: Configure CMake
        run: |
          Write-Host "=== Verifying required files ==="
          if (!(Test-Path LICENSE)) {
            Write-Host "ERROR: LICENSE file not found!"
            exit 1
          } else {
            Write-Host "✓ LICENSE file found"
          }
          if (!(Test-Path resources/treemk.ico)) {
            Write-Host "WARNING: treemk.ico not found"
          } else {
            Write-Host "✓ treemk.ico found"
          }
          
          Write-Host "=== Configuring CMake ==="
          mkdir build
          cd build
          cmake .. -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
      
      - name: Build Application
        run: |
          cd build
          cmake --build . --config Release
      
      - name: Deploy Qt dependencies
        run: |
          cd build\Release
          windeployqt treemk.exe --webenginewidgets --release --no-translations --no-system-d3d-compiler --no-opengl-sw
          if ($LASTEXITCODE -ne 0) {
            Write-Host "First attempt failed, trying with minimal options..."
            windeployqt treemk.exe --release --no-translations
          }
      
      - name: Install NSIS
        run: |
          choco install nsis -y
      
      - name: Create Windows Installer
        run: |
          cd build
          cpack -G NSIS -C Release
      
      - name: Upload Installer
        uses: actions/upload-artifact@v4
        with:
          name: TreeMk-Windows-x64
          path: build/TreeMk-*.exe
      
      - name: Upload to Latest Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          files: build/TreeMk-*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
